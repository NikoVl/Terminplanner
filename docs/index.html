<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Terminbuchung</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 2rem; }
    h1 { color: #333; }
    #slots { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .slot-button {
      padding: 10px 15px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>Termin buchen (nächste 6 Monate)</h1>
<p>Wähle einen freien 1-Stunden-Slot für dein Gespräch:</p>
<div id="slots">Lade freie Termine...</div>

<script>
  const CALENDAR_ID = 'primary'; // oder deine Google Calendar-ID
  const API_KEY = 'AIzaSyA22vp3yXmWm4AS1o8sMwpLfhAn-SF8pDU';
  const CLIENT_ID = '813246746655-m9hh847l8tavktaqfpnr24bm0i09hhpc.apps.googleusercontent.com'; // <-- dein OAuth Client ID
  const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
  const WORKING_HOURS = { start: 8, end: 18 };

  function loadGAPI() {
    gapi.load('client:auth2', async () => {
      await gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, scope: SCOPES });
      await gapi.auth2.getAuthInstance().signIn(); // Kunde muss sich einloggen
      listFreeSlots();
    });
  }

  async function listFreeSlots() {
    const now = new Date();
    const endDate = new Date();
    endDate.setMonth(endDate.getMonth() + 1); // 1 Monat wegen API-Limit

    const res = await gapi.client.calendar.freebusy.query({
      timeMin: now.toISOString(),
      timeMax: endDate.toISOString(),
      timeZone: 'Europe/Berlin',
      items: [{ id: CALENDAR_ID }]
    });

    const busySlots = (res.result.calendars[CALENDAR_ID].busy || []).map(b => ({
      start: new Date(b.start),
      end: new Date(b.end)
    }));

    const freeSlots = findFreeSlots(now, endDate, busySlots);
    renderSlots(freeSlots);
  }

  function findFreeSlots(startDate, endDate, busy) {
    const free = [];
    const current = new Date(startDate);

    while (current < endDate) {
      const day = current.getDay();
      if (day > 0 && day < 6) { // Montag–Freitag
        for (let hour = WORKING_HOURS.start; hour < WORKING_HOURS.end; hour++) {
          const slotStart = new Date(current.setHours(hour, 0, 0, 0));
          const slotEnd = new Date(current.setHours(hour + 1, 0, 0, 0));
          const overlaps = busy.some(b => slotStart < b.end && slotEnd > b.start);
          if (!overlaps && slotStart > new Date()) {
            free.push(new Date(slotStart));
          }
        }
      }
      current.setDate(current.getDate() + 1);
      current.setHours(0, 0, 0, 0);
    }
    return free;
  }

  function renderSlots(slots) {
    const container = document.getElementById('slots');
    container.innerHTML = '';

    if (slots.length === 0) {
      container.innerText = 'Keine freien Termine gefunden.';
      return;
    }

    slots.forEach(slot => {
      const start = new Date(slot);
      const end = new Date(start.getTime() + 60 * 60 * 1000);

      const dateStr = start.toLocaleDateString('de-DE');
      const startTime = start.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      const endTime = end.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

      const btn = document.createElement('button');
      btn.className = 'slot-button';
      btn.innerText = `${dateStr}, ${startTime} bis ${endTime} Uhr`;

      btn.onclick = () => createEvent(start, end, btn);
      container.appendChild(btn);
    });
  }

  async function createEvent(start, end, button) {
    const event = {
      summary: 'Geplantes Gespräch',
      description: 'Kundentermin (automatisch gebucht)',
      start: {
        dateTime: start.toISOString(),
        timeZone: 'Europe/Berlin'
      },
      end: {
        dateTime: end.toISOString(),
        timeZone: 'Europe/Berlin'
      }
    };

    try {
      const res = await gapi.client.calendar.events.insert({
        calendarId: CALENDAR_ID,
        resource: event
      });

      alert('Termin gebucht für:\n' + new Date(start).toLocaleString('de-DE'));
      button.disabled = true;
      button.style.backgroundColor = 'gray';
      button.innerText = 'Gebucht!';
    } catch (err) {
      console.error('Fehler beim Erstellen des Termins:', err);
      alert('Termin konnte nicht gebucht werden. Bitte versuche es erneut.');
    }
  }

  window.onload = loadGAPI;
</script>

</body>
</html>
