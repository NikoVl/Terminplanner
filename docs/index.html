<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Terminbuchung</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 2rem; }
    h1 { color: #333; }
    #slots { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .slot-button {
      padding: 10px 15px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>Termin buchen (nächste 6 Monate)</h1>
<p>Wähle einen freien 1-Stunden-Slot für dein Gespräch:</p>
<div id="slots">Lade freie Termine...</div>

<script>    
  const calendarId = 'pedinovl97@gmail.com'; // <- richtige ID eintragen
  const API_KEY = 'AIzaSyA22vp3yXmWm4AS1o8sMwpLfhAn-SF8pDU'; // <- dein API Key
  const WORKING_HOURS = { start: 8, end: 18 }; // 8–18 Uhr

  function loadGAPI() {
    gapi.load('client', () => {
      gapi.client.init({ apiKey: API_KEY }).then(listFreeSlots);
    });
  }

  function listFreeSlots() {
    const now = new Date();
    const endDate = new Date();
    endDate.setMonth(endDate.getMonth() + 6);

    gapi.client.calendar.freebusy.query({
      resource: {
        timeMin: now.toISOString(),
        timeMax: endDate.toISOString(),
        timeZone: 'Europe/Berlin',
        items: [{ id: CALENDAR_ID }]
      }
    }).then(res => {
      const busySlots = res.result.calendars[CALENDAR_ID].busy.map(b => ({
        start: new Date(b.start),
        end: new Date(b.end)
      }));

      const freeSlots = findFreeSlots(now, endDate, busySlots);
      renderSlots(freeSlots);
    }).catch(err => {
      document.getElementById('slots').innerText = 'Fehler beim Laden: ' + err.message;
      console.error(err);
    });
  }

  function findFreeSlots(startDate, endDate, busy) {
    const free = [];
    const current = new Date(startDate);

    while (current < endDate) {
      const day = current.getDay();
      if (day > 0 && day < 6) { // Montag bis Freitag
        for (let hour = WORKING_HOURS.start; hour < WORKING_HOURS.end; hour++) {
          const slotStart = new Date(current.setHours(hour, 0, 0, 0));
          const slotEnd = new Date(current.setHours(hour + 1, 0, 0, 0));

          const overlaps = busy.some(b =>
            (slotStart < b.end && slotEnd > b.start)
          );

          if (!overlaps && slotStart > new Date()) {
            free.push(new Date(slotStart));
          }
        }
      }
      current.setDate(current.getDate() + 1);
      current.setHours(0, 0, 0, 0);
    }

    return free;
  }

  function renderSlots(slots) {
    const container = document.getElementById('slots');
    container.innerHTML = '';

    if (slots.length === 0) {
      container.innerText = 'Keine freien Termine gefunden.';
      return;
    }

    slots.forEach(slot => {
      const btn = document.createElement('button');
      btn.className = 'slot-button';
      btn.innerText = slot.toLocaleString('de-DE');
      btn.onclick = () => alert(`Du hast ${slot.toLocaleString('de-DE')} ausgewählt`);
      container.appendChild(btn);
    });
  }

  window.onload = loadGAPI;
</script>

</body>
</html>
